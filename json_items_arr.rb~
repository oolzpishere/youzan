# coding: utf-8
require 'digest/md5'
require 'net/http'
require 'json'
require 'pry'
require_relative 'uri'
require_relative 'out_of_date_sku'
require_relative 'items_arr'

module Youzan
  class ParseWorker
    attr_reader :uri, :json_arr, :api_type

    def initialize(opts)
      @uri = Youzan::Uri.new(opts).gen_uri
      @api_type = opts[:api_type]
    end

    def run

      downloader = http_get
      class_name = 'Youzan::' +  api_type.split('_').map(&:capitalize).join + 'Json'
      @json_arr = Object.const_get(class_name).new(downloader).parse_json
      #write_to_file json_arr
      @json_arr
    end
    
    def http_get
      #binding.pry
      Net::HTTP.get(uri)
    end
    
    def write_to_file(json)
      #binding.pry
      File.write("yz_parse_json", JSON.pretty_generate(json))
    end
    #binding.pry
    
  end
end

# api eg. kdt.items.onsale.get = kdt_items_onsale_get

